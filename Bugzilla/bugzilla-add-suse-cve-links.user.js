// ==UserScript==
// @name        Bugzilla - Add SUSE CVE page link
// @namespace   SUSE SecTools
// @match       https://bugzilla.suse.com/show_bug.cgi?*
// @run-at      document-end
// @grant       none
// @version     1.0.0
// @author      gsonnu
// @description Add links to SUSE CVE pages in title and comments
// ==/UserScript==


(function() {
    const cveRegex = /CVE-[0-9]{4}-[0-9]*/gi;

    function createAnchor(url, text) {
        let link = document.createElement('a');
        link.setAttribute('href', url);
        link.textContent = text;

        return link;
    }

    function createTextNode(text) {
        if (text == null || typeof(text) === 'undefined')
            return null;

        return document.createTextNode(text);
    }

    function replaceCveWithUrls(elem) {
        if (!elem)
            return;

        let results = [];
        let text = elem.textContent;
        let newElem = elem.cloneNode(true);
        let index = 0;
        let r = null;

        newElem.textContent = '';

        while (r = cveRegex.exec(text)) {
            // add text before, if any
            newElem.appendChild(createTextNode(text.slice(index, r.index)));

            // add CVE as link
            newElem.appendChild(createAnchor(`https://www.suse.com/security/cve/${r[0]}.html`,
                                             r[0]));

            // update index
            index = r.index + r[0].length;
        }

        // add other text
        if (index < (text.length - 1))
            newElem.appendChild(createTextNode(text.slice(index)));

        elem.replaceWith(newElem);
    }

    replaceCveWithUrls(document.querySelector('#alias_nonedit_display'));
    replaceCveWithUrls(document.querySelector('#short_desc_nonedit_display'));

    for (let comment of document.querySelectorAll('.bz_comment_text')) {
        replaceCveWithUrls(comment);
    }

})();
